<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DBD Widget Settings v5</title>
  <style>
    :root{
      --bg0:#07080c; --bg1:#0b0c10;
      --card: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.10);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --pink:#f2b7e6;
      --pill: rgba(160,160,190,.25);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 10px 35px rgba(0,0,0,.35);
      --radius: 22px;
    }
    html,body{
      margin:0;
      background:
        radial-gradient(1100px 700px at 30% 20%, rgba(255,74,24,.10), transparent 60%),
        radial-gradient(900px 600px at 70% 40%, rgba(120,160,255,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:#e9e9e9;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .wrap{ min-height:100vh; display:grid; place-items:center; padding: 26px 16px 44px; }
    .container{ width: min(1180px, 100%); display:grid; gap: 14px; }

    .hero{
      position: relative; border-radius: 34px;
      background: linear-gradient(90deg, rgba(190,170,255,.22), rgba(160,220,255,.14));
      box-shadow: var(--shadow); padding: 22px 22px 18px; overflow:hidden; text-align:center;
    }
    .hero::before{
      content:""; position:absolute; inset:-60px;
      background:
        radial-gradient(900px 300px at 25% 70%, rgba(255,74,24,.18), transparent 60%),
        radial-gradient(700px 260px at 70% 40%, rgba(255,255,255,.10), transparent 60%);
      filter: blur(18px); opacity: .9; pointer-events:none;
    }
    .heroInner{ position:relative; z-index:2; }
    .heroTitle{ margin:0; font-size: clamp(34px, 5vw, 62px); font-weight: 1000; letter-spacing: .6px; text-shadow: 0 10px 26px rgba(0,0,0,.35); }
    .heroSub{ margin-top: 6px; font-size: 22px; letter-spacing: 2px; font-weight: 1000; color: var(--pink); text-transform: uppercase; text-shadow: 0 8px 18px rgba(0,0,0,.25); }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(8px);
    }
    .chip{
      display:inline-flex; align-items:center; gap: 10px;
      padding: 10px 14px; border-radius: 999px;
      background: var(--pill);
      border: 1px solid rgba(255,255,255,.10);
      margin-bottom: 8px;
    }
    .skull{
      width: 28px; height: 28px; display:grid; place-items:center;
      border-radius: 999px; background: rgba(0,0,0,.32);
      border: 1px solid rgba(255,255,255,.08);
      font-size: 16px;
    }
    .card h2{ margin:0; font-size: 18px; font-weight: 1000; letter-spacing: .3px; }

    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items:center;
      margin: 10px 0;
    }
    label{ color: rgba(255,255,255,.90); font-weight: 800; }
    .hint{ color: var(--muted2); font-size: 12px; margin-top: 2px; }

    input[type="text"], input[type="number"], select, textarea{
      width: 360px; max-width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.32);
      color: #fff;
      outline: none;
    }
    textarea{ min-height: 110px; resize: vertical; }
    input[type="number"]{ width: 140px; }
    input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus{
      border-color: rgba(242,183,230,.55);
      box-shadow: 0 0 0 3px rgba(242,183,230,.18);
    }
    input[type="color"]{ width: 58px; height: 40px; border-radius: 12px; border: none; background: transparent; padding: 0; }
    input[type="range"]{ width: 360px; max-width:100%; }
    input[type="file"]{ width: 360px; max-width: 100%; }

    .btns{ display:flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button{
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color:#fff;
      font-weight: 900;
      cursor:pointer;
    }
    button:hover{ background: rgba(255,255,255,.14); }

    .wide{ grid-column: 1 / -1; }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 980px){ .split{ grid-template-columns:1fr; } }

    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(0,0,0,.35);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
    }
    hr{ border:none; border-top:1px solid rgba(255,255,255,.12); margin: 14px 0; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="container">
      <div class="hero">
        <div class="heroInner">
          <h1 class="heroTitle">DBD Scoreboard</h1>
          <div class="heroSub">Settings v5 (Nasty Mode)</div>
        </div>
      </div>

      <div class="grid">

        <div class="card">
          <div class="chip"><div class="skull">üíÄ</div><h2>Basics</h2></div>

          <div class="row">
            <div>
              <label>Twitch Channel</label>
              <div class="hint">Used for chat commands: !dbdwin / !dbdlose / !dbdreset</div>
            </div>
            <input id="channel" type="text" placeholder="ghostephace">
          </div>

          <div class="row">
            <div>
              <label>Who can use commands?</label>
              <div class="hint">Keep ‚ÄúMods only‚Äù so randoms can‚Äôt mess your scores</div>
            </div>
            <select id="allowEveryone">
              <option value="false">Broadcaster/Mods only</option>
              <option value="true">Everyone</option>
            </select>
          </div>

          <div class="row">
            <div>
              <label>Visibility</label>
              <div class="hint">Always show OR only show when commands happen</div>
            </div>
            <select id="visibility">
              <option value="always">Always</option>
              <option value="command">Command mode</option>
            </select>
          </div>

          <div class="row">
            <div>
              <label>Show seconds (command mode)</label>
              <div class="hint">How long it stays visible after a score update</div>
            </div>
            <input id="showSeconds" type="range" min="2" max="30" step="1">
          </div>

          <div class="row">
            <div>
              <label>Hide initially (command mode)</label>
              <div class="hint">Start hidden and only appear on commands</div>
            </div>
            <select id="hideInitially">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>

          <div class="btns">
            <button id="btnShow">Show Now</button>
            <button id="btnHide">Hide Now</button>
            <button id="btnReset">Reset Scores</button>
          </div>

          <div class="hint" style="margin-top:10px;">
            Chat: <code>!dbdwin</code> <code>!dbdlose</code> <code>!dbdreset</code> <code>!dbdset 3 2</code>
          </div>
        </div>

        <div class="card">
          <div class="chip"><div class="skull">üíÄ</div><h2>Score Test</h2></div>

          <div class="row">
            <div><label>Win score</label></div>
            <input id="scoreWin" type="number" min="0" max="99">
          </div>
          <div class="row">
            <div><label>Lose score</label></div>
            <input id="scoreLose" type="number" min="0" max="99">
          </div>

          <div class="btns">
            <button id="btnWinPlus">Win +1</button>
            <button id="btnLosePlus">Lose +1</button>
            <button id="btnApplyScores">Apply</button>
            <button id="btnHardZero">Zero</button>
          </div>

          <div class="hint" style="margin-top:10px;">
            If this updates here but not in Streamlabs overlay: change the overlay URL version param (cache-buster).
          </div>
        </div>

        <div class="card wide">
          <div class="chip"><div class="skull">üíÄ</div><h2>Layout</h2></div>

          <div class="split">
            <div>
              <div class="row"><label>Width</label><input id="w" type="range" min="700" max="1500" step="1"></div>
              <div class="row"><label>Height</label><input id="h" type="range" min="130" max="260" step="1"></div>
              <div class="row"><label>Scale</label><input id="scale" type="range" min="0.6" max="1.8" step="0.01"></div>
              <div class="row"><label>Corner radius</label><input id="radius" type="range" min="40" max="999" step="1"></div>
              <div class="row"><label>Side column width</label><input id="colW" type="range" min="120" max="260" step="1"></div>
            </div>

            <div>
              <div class="row"><label>Padding X</label><input id="padX" type="range" min="0" max="60" step="1"></div>
              <div class="row"><label>Gap</label><input id="gap" type="range" min="0" max="40" step="1"></div>
              <div class="row"><label>Circle size</label><input id="circle" type="range" min="100" max="200" step="1"></div>
              <div class="row"><label>Icon size</label><input id="icon" type="range" min="32" max="90" step="1"></div>
              <div class="row"><label>Icon/label gap</label><input id="stackGap" type="range" min="0" max="20" step="1"></div>
            </div>
          </div>
        </div>

        <div class="card wide">
          <div class="chip"><div class="skull">üíÄ</div><h2>Typography</h2></div>

          <div class="split">
            <div>
              <div class="row">
                <div>
                  <label>Font family</label>
                  <div class="hint">Works best when hosted (GitHub Pages). Example: Inter, Arial</div>
                </div>
                <input id="font" type="text" placeholder="ui-sans-serif, system-ui, ...">
              </div>

              <div class="row"><label>Number size</label><input id="numSize" type="range" min="50" max="130" step="1"></div>
              <div class="row"><label>Number weight</label><input id="numWeight" type="range" min="400" max="1000" step="50"></div>
            </div>

            <div>
              <div class="row"><label>Label size</label><input id="labelSize" type="range" min="12" max="36" step="1"></div>
              <div class="row"><label>Label letter spacing</label><input id="labelSpacing" type="range" min="0" max="6" step="0.1"></div>
            </div>
          </div>
        </div>

        <div class="card wide">
          <div class="chip"><div class="skull">üíÄ</div><h2>Colors & Glow</h2></div>

          <div class="split">
            <div>
              <div class="row"><label>Background (rgba)</label><input id="bg" type="text" placeholder="rgba(13, 13, 14, 0.75)"></div>
              <div class="row"><label>Border</label><input id="border" type="text" placeholder="rgba(255,255,255,.06)"></div>

              <div class="row"><label>Main text</label><input id="textMain" type="color"></div>
              <div class="row"><label>Secondary text</label><input id="textSub" type="color"></div>
              <div class="row"><label>Highlight</label><input id="highlight" type="color"></div>
            </div>

            <div>
              <div class="row"><label>Glow inner</label><input id="glowA" type="range" min="0" max="1" step="0.01"></div>
              <div class="row"><label>Glow mid</label><input id="glowB" type="range" min="0" max="1" step="0.01"></div>
              <div class="row"><label>Glow outer</label><input id="glowC" type="range" min="0" max="1" step="0.01"></div>
            </div>
          </div>

          <hr>

          <div class="split">
            <div>
              <div class="row"><label>Win spinner color</label><input id="spinWin" type="color"></div>
              <div class="row"><label>Lose spinner color</label><input id="spinLose" type="color"></div>
              <div class="row"><label>Spinner thickness</label><input id="spinThick" type="range" min="1" max="10" step="1"></div>
              <div class="row">
                <div><label>Spinner enabled</label></div>
                <select id="spinnerOn"><option value="true">On</option><option value="false">Off</option></select>
              </div>
            </div>

            <div>
              <div class="row"><label>Win pulse color</label><input id="pulseWin" type="color"></div>
              <div class="row"><label>Lose pulse color</label><input id="pulseLose" type="color"></div>
            </div>
          </div>
        </div>

        <div class="card wide">
          <div class="chip"><div class="skull">üíÄ</div><h2>Icons (Upload + Tint)</h2></div>

          <div class="split">
            <div>
              <div class="row"><label>Left label</label><input id="leftLabel" type="text"></div>
              <div class="row">
                <div><label>Left icon mode</label></div>
                <select id="leftIconMode">
                  <option value="svg">SVG</option>
                  <option value="upload">Upload PNG</option>
                </select>
              </div>
              <div class="row">
                <div><label>Left SVG</label></div>
                <select id="leftIconSvg">
                  <option value="trophy">trophy</option>
                  <option value="skull">skull</option>
                  <option value="exit">exit</option>
                  <option value="sad">sad</option>
                </select>
              </div>
              <div class="row"><label>Left PNG upload</label><input id="leftFile" type="file" accept="image/png"></div>
              <div class="row">
                <div><label>Left tint</label></div>
                <select id="leftTintOn"><option value="true">On</option><option value="false">Off</option></select>
              </div>
              <div class="row"><label>Left tint color</label><input id="leftTintColor" type="color"></div>
            </div>

            <div>
              <div class="row"><label>Right label</label><input id="rightLabel" type="text"></div>
              <div class="row">
                <div><label>Right icon mode</label></div>
                <select id="rightIconMode">
                  <option value="svg">SVG</option>
                  <option value="upload">Upload PNG</option>
                </select>
              </div>
              <div class="row">
                <div><label>Right SVG</label></div>
                <select id="rightIconSvg">
                  <option value="sad">sad</option>
                  <option value="skull">skull</option>
                  <option value="exit">exit</option>
                  <option value="trophy">trophy</option>
                </select>
              </div>
              <div class="row"><label>Right PNG upload</label><input id="rightFile" type="file" accept="image/png"></div>
              <div class="row">
                <div><label>Right tint</label></div>
                <select id="rightTintOn"><option value="true">On</option><option value="false">Off</option></select>
              </div>
              <div class="row"><label>Right tint color</label><input id="rightTintColor" type="color"></div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px;">
            Upload saves in the browser storage of whatever app you‚Äôre editing in (Streamlabs vs Chrome are separate).
          </div>
        </div>

        <div class="card wide">
          <div class="chip"><div class="skull">üíÄ</div><h2>Effects (Nasty)</h2></div>

          <div class="split">
            <div>
              <div class="row"><div><label>Sheen</label></div><select id="sheenOn"><option value="true">On</option><option value="false">Off</option></select></div>
              <div class="row"><label>Sheen opacity</label><input id="sheenOpacity" type="range" min="0" max="1" step="0.01"></div>
              <div class="row"><label>Sheen speed (sec)</label><input id="sheenSpeedSec" type="range" min="1" max="10" step="0.1"></div>

              <hr>

              <div class="row"><div><label>Scanlines</label></div><select id="scanOn"><option value="true">On</option><option value="false">Off</option></select></div>
              <div class="row"><label>Scan opacity</label><input id="scanOpacity" type="range" min="0" max="0.6" step="0.01"></div>
              <div class="row"><label>Scan spacing</label><input id="scanStep" type="range" min="3" max="14" step="1"></div>
            </div>

            <div>
              <div class="row"><div><label>Grain</label></div><select id="grainOn"><option value="true">On</option><option value="false">Off</option></select></div>
              <div class="row"><label>Grain opacity</label><input id="grainOpacity" type="range" min="0" max="0.6" step="0.01"></div>
              <div class="row"><label>Grain size</label><input id="grainSize" type="range" min="60" max="240" step="1"></div>

              <hr>

              <div class="row"><div><label>Vignette</label></div><select id="vignetteOn"><option value="true">On</option><option value="false">Off</option></select></div>
              <div class="row"><label>Vignette strength</label><input id="vignette" type="range" min="0" max="0.8" step="0.01"></div>
            </div>
          </div>

          <hr>

          <div class="split">
            <div>
              <div class="row"><div><label>Chroma glitch</label></div><select id="chromaOn"><option value="true">On</option><option value="false">Off</option></select></div>
              <div class="row"><label>Chroma px</label><input id="chromaPx" type="range" min="0" max="8" step="1"></div>

              <div class="row"><div><label>Shake on score</label></div><select id="shakeOn"><option value="true">On</option><option value="false">Off</option></select></div>
            </div>

            <div>
              <div class="row"><div><label>Sparks burst</label></div><select id="sparksOn"><option value="true">On</option><option value="false">Off</option></select></div>
              <div class="row"><label>Sparks amount</label><input id="sparksAmount" type="range" min="0" max="120" step="1"></div>
            </div>
          </div>
        </div>

        <div class="card wide">
          <div class="chip"><div class="skull">üíÄ</div><h2>Embers</h2></div>

          <div class="split">
            <div>
              <div class="row"><div><label>Enabled</label></div><select id="emberEnabled"><option value="true">On</option><option value="false">Off</option></select></div>
              <div class="row"><label>Opacity</label><input id="emberOpacity" type="range" min="0" max="1" step="0.01"></div>
              <div class="row"><label>Speed</label><input id="emberSpeed" type="range" min="0.1" max="2" step="0.01"></div>
              <div class="row"><label>Density target</label><input id="emberTarget" type="range" min="0" max="160" step="1"></div>
            </div>

            <div>
              <div class="row"><label>Ember Color 1</label><input id="emberC1" type="color"></div>
              <div class="row"><label>Ember Color 2</label><input id="emberC2" type="color"></div>
              <div class="row"><label>Ember Color 3</label><input id="emberC3" type="color"></div>
            </div>
          </div>
        </div>

        <div class="card wide">
          <div class="chip"><div class="skull">üß™</div><h2>Export / Import</h2></div>
          <div class="row">
            <div>
              <label>Settings JSON</label>
              <div class="hint">Copy/paste this between machines or share with friends.</div>
            </div>
            <textarea id="jsonBox" placeholder="Click Export‚Ä¶"></textarea>
          </div>
          <div class="btns">
            <button id="btnExport">Export</button>
            <button id="btnImport">Import</button>
            <button id="btnFactory">Factory Reset</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "dbd_widget_v5";
    const bc = ("BroadcastChannel" in window) ? new BroadcastChannel("dbd_widget_channel_v5") : null;

    const DEFAULTS = {
      channel: "ghostephace",
      allowEveryone: false,

      scoreWin: 0,
      scoreLose: 0,

      visibility: "always",
      showSeconds: 8,
      hideInitially: true,

      layout: { w:980, h:170, scale:1, radius:999, padX:18, colW:175, gap:12, circle:140, icon:56, stackGap:4 },

      typography: { font:"ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial", numSize:86, numWeight:1000, labelSize:20, labelSpacing:1 },

      colors: {
        bg:"rgba(13, 13, 14, 0.75)",
        border:"rgba(255,255,255,.06)",
        textMain:"#EFEFEF",
        textSub:"#C0C0C0",
        highlight:"#FF4500",
        spinWin:"#00FF00",
        spinLose:"#00FF00",
        pulseWin:"#FFFF00",
        pulseLose:"#FFFF00"
      },

      glow: { a:0.45, b:0.45, c:0.22 },

      spinner: { on:true, thick:3 },

      effects: {
        sheenOn:true, sheenOpacity:0.35, sheenSpeedSec:3.2,
        scanOn:true, scanOpacity:0.16, scanStep:6,
        grainOn:true, grainOpacity:0.14, grainSize:120,
        vignetteOn:true, vignette:0.28,
        chromaOn:true, chromaPx:2,
        shakeOn:true,
        sparksOn:true, sparksAmount:26
      },

      ember: { enabled:true, colors:["#bc2e9f","#FFA500","#bc2e9f"], opacity:0.5, speed:0.6, targetCount:70 },

      textIcons: {
        leftLabel:"killed", rightLabel:"failed",
        leftIconMode:"svg", rightIconMode:"svg",
        leftIconSvg:"trophy", rightIconSvg:"sad",
        leftIconData:"", rightIconData:"",
        leftTintOn:true, rightTintOn:true,
        leftTintColor:"#FF4500", rightTintColor:"#FF4500"
      }
    };

    const $ = (id) => document.getElementById(id);

    function deepMerge(base, patch){
      const out = { ...base };
      for(const k of Object.keys(patch || {})){
        const v = patch[k];
        if(v && typeof v === "object" && !Array.isArray(v)) out[k] = deepMerge(base[k] || {}, v);
        else out[k] = v;
      }
      return out;
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(DEFAULTS);
        return deepMerge(structuredClone(DEFAULTS), JSON.parse(raw));
      } catch { return structuredClone(DEFAULTS); }
    }

    let state = loadState();

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      bc?.postMessage({ type:"state", state });
    }

    function clamp(n, min=0, max=99){
      n = Number(n);
      if(!Number.isFinite(n)) n = 0;
      return Math.max(min, Math.min(max, Math.round(n)));
    }

    async function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    function bind(){
      $("channel").value = state.channel;
      $("allowEveryone").value = String(state.allowEveryone);
      $("visibility").value = state.visibility;
      $("showSeconds").value = state.showSeconds;
      $("hideInitially").value = String(state.hideInitially);

      $("scoreWin").value = state.scoreWin;
      $("scoreLose").value = state.scoreLose;

      // layout
      $("w").value = state.layout.w;
      $("h").value = state.layout.h;
      $("scale").value = state.layout.scale;
      $("radius").value = state.layout.radius;
      $("padX").value = state.layout.padX;
      $("colW").value = state.layout.colW;
      $("gap").value = state.layout.gap;
      $("circle").value = state.layout.circle;
      $("icon").value = state.layout.icon;
      $("stackGap").value = state.layout.stackGap;

      // typography
      $("font").value = state.typography.font;
      $("numSize").value = state.typography.numSize;
      $("numWeight").value = state.typography.numWeight;
      $("labelSize").value = state.typography.labelSize;
      $("labelSpacing").value = state.typography.labelSpacing;

      // colors/glow
      $("bg").value = state.colors.bg;
      $("border").value = state.colors.border;
      $("textMain").value = state.colors.textMain;
      $("textSub").value = state.colors.textSub;
      $("highlight").value = state.colors.highlight;

      $("glowA").value = state.glow.a;
      $("glowB").value = state.glow.b;
      $("glowC").value = state.glow.c;

      $("spinWin").value = state.colors.spinWin;
      $("spinLose").value = state.colors.spinLose;
      $("spinThick").value = state.spinner.thick;
      $("spinnerOn").value = String(state.spinner.on);

      $("pulseWin").value = state.colors.pulseWin;
      $("pulseLose").value = state.colors.pulseLose;

      // icons
      $("leftLabel").value = state.textIcons.leftLabel;
      $("rightLabel").value = state.textIcons.rightLabel;
      $("leftIconMode").value = state.textIcons.leftIconMode;
      $("rightIconMode").value = state.textIcons.rightIconMode;
      $("leftIconSvg").value = state.textIcons.leftIconSvg;
      $("rightIconSvg").value = state.textIcons.rightIconSvg;
      $("leftTintOn").value = String(state.textIcons.leftTintOn);
      $("rightTintOn").value = String(state.textIcons.rightTintOn);
      $("leftTintColor").value = state.textIcons.leftTintColor;
      $("rightTintColor").value = state.textIcons.rightTintColor;

      // effects
      $("sheenOn").value = String(state.effects.sheenOn);
      $("sheenOpacity").value = state.effects.sheenOpacity;
      $("sheenSpeedSec").value = state.effects.sheenSpeedSec;

      $("scanOn").value = String(state.effects.scanOn);
      $("scanOpacity").value = state.effects.scanOpacity;
      $("scanStep").value = state.effects.scanStep;

      $("grainOn").value = String(state.effects.grainOn);
      $("grainOpacity").value = state.effects.grainOpacity;
      $("grainSize").value = state.effects.grainSize;

      $("vignetteOn").value = String(state.effects.vignetteOn);
      $("vignette").value = state.effects.vignette;

      $("chromaOn").value = String(state.effects.chromaOn);
      $("chromaPx").value = state.effects.chromaPx;

      $("shakeOn").value = String(state.effects.shakeOn);

      $("sparksOn").value = String(state.effects.sparksOn);
      $("sparksAmount").value = state.effects.sparksAmount;

      // embers
      $("emberEnabled").value = String(state.ember.enabled);
      $("emberOpacity").value = state.ember.opacity;
      $("emberSpeed").value = state.ember.speed;
      $("emberTarget").value = state.ember.targetCount;
      $("emberC1").value = state.ember.colors[0];
      $("emberC2").value = state.ember.colors[1];
      $("emberC3").value = state.ember.colors[2];
    }

    function wire(){
      // Basics
      $("channel").addEventListener("input", () => { state.channel = $("channel").value.trim() || "ghostephace"; saveState(); });
      $("allowEveryone").addEventListener("change", () => { state.allowEveryone = $("allowEveryone").value === "true"; saveState(); });
      $("visibility").addEventListener("change", () => { state.visibility = $("visibility").value; saveState(); });
      $("showSeconds").addEventListener("input", () => { state.showSeconds = clamp($("showSeconds").value,2,30); saveState(); });
      $("hideInitially").addEventListener("change", () => { state.hideInitially = $("hideInitially").value === "true"; saveState(); });

      $("btnShow").addEventListener("click", () => bc?.postMessage({type:"show"}));
      $("btnHide").addEventListener("click", () => bc?.postMessage({type:"hide"}));
      $("btnReset").addEventListener("click", () => { state.scoreWin = 0; state.scoreLose = 0; saveState(); bind(); });

      // Score test
      $("btnWinPlus").addEventListener("click", () => { state.scoreWin = clamp(state.scoreWin + 1); saveState(); bind(); });
      $("btnLosePlus").addEventListener("click", () => { state.scoreLose = clamp(state.scoreLose + 1); saveState(); bind(); });
      $("btnApplyScores").addEventListener("click", () => {
        state.scoreWin = clamp($("scoreWin").value,0,99);
        state.scoreLose = clamp($("scoreLose").value,0,99);
        saveState();
      });
      $("btnHardZero").addEventListener("click", () => { state.scoreWin = 0; state.scoreLose = 0; saveState(); bind(); });

      // layout
      const bindRange = (id, fn) => $(id).addEventListener("input", () => { fn(); saveState(); });
      bindRange("w", () => state.layout.w = clamp($("w").value,700,1500));
      bindRange("h", () => state.layout.h = clamp($("h").value,130,260));
      $("scale").addEventListener("input", () => { state.layout.scale = parseFloat($("scale").value); saveState(); });
      bindRange("radius", () => state.layout.radius = clamp($("radius").value,40,999));
      bindRange("padX", () => state.layout.padX = clamp($("padX").value,0,60));
      bindRange("colW", () => state.layout.colW = clamp($("colW").value,120,260));
      bindRange("gap", () => state.layout.gap = clamp($("gap").value,0,40));
      bindRange("circle", () => state.layout.circle = clamp($("circle").value,100,200));
      bindRange("icon", () => state.layout.icon = clamp($("icon").value,32,90));
      bindRange("stackGap", () => state.layout.stackGap = clamp($("stackGap").value,0,20));

      // typography
      $("font").addEventListener("input", () => { state.typography.font = $("font").value.trim() || DEFAULTS.typography.font; saveState(); });
      bindRange("numSize", () => state.typography.numSize = clamp($("numSize").value,50,130));
      bindRange("numWeight", () => state.typography.numWeight = clamp($("numWeight").value,400,1000));
      bindRange("labelSize", () => state.typography.labelSize = clamp($("labelSize").value,12,36));
      $("labelSpacing").addEventListener("input", () => { state.typography.labelSpacing = parseFloat($("labelSpacing").value); saveState(); });

      // colors/glow
      $("bg").addEventListener("input", () => { state.colors.bg = $("bg").value.trim() || DEFAULTS.colors.bg; saveState(); });
      $("border").addEventListener("input", () => { state.colors.border = $("border").value.trim() || DEFAULTS.colors.border; saveState(); });
      $("textMain").addEventListener("change", () => { state.colors.textMain = $("textMain").value; saveState(); });
      $("textSub").addEventListener("change", () => { state.colors.textSub = $("textSub").value; saveState(); });
      $("highlight").addEventListener("change", () => {
        state.colors.highlight = $("highlight").value;
        // keep tint colors in sync if they feel highlight-y
        state.textIcons.leftTintColor = state.textIcons.leftTintColor || state.colors.highlight;
        state.textIcons.rightTintColor = state.textIcons.rightTintColor || state.colors.highlight;
        saveState();
        bind();
      });

      $("glowA").addEventListener("input", () => { state.glow.a = parseFloat($("glowA").value); saveState(); });
      $("glowB").addEventListener("input", () => { state.glow.b = parseFloat($("glowB").value); saveState(); });
      $("glowC").addEventListener("input", () => { state.glow.c = parseFloat($("glowC").value); saveState(); });

      $("spinWin").addEventListener("change", () => { state.colors.spinWin = $("spinWin").value; saveState(); });
      $("spinLose").addEventListener("change", () => { state.colors.spinLose = $("spinLose").value; saveState(); });
      $("spinThick").addEventListener("input", () => { state.spinner.thick = clamp($("spinThick").value,1,10); saveState(); });
      $("spinnerOn").addEventListener("change", () => { state.spinner.on = $("spinnerOn").value === "true"; saveState(); });

      $("pulseWin").addEventListener("change", () => { state.colors.pulseWin = $("pulseWin").value; saveState(); });
      $("pulseLose").addEventListener("change", () => { state.colors.pulseLose = $("pulseLose").value; saveState(); });

      // icons
      $("leftLabel").addEventListener("input", () => { state.textIcons.leftLabel = $("leftLabel").value.trim() || "killed"; saveState(); });
      $("rightLabel").addEventListener("input", () => { state.textIcons.rightLabel = $("rightLabel").value.trim() || "failed"; saveState(); });

      $("leftIconMode").addEventListener("change", () => { state.textIcons.leftIconMode = $("leftIconMode").value; saveState(); });
      $("rightIconMode").addEventListener("change", () => { state.textIcons.rightIconMode = $("rightIconMode").value; saveState(); });
      $("leftIconSvg").addEventListener("change", () => { state.textIcons.leftIconSvg = $("leftIconSvg").value; saveState(); });
      $("rightIconSvg").addEventListener("change", () => { state.textIcons.rightIconSvg = $("rightIconSvg").value; saveState(); });

      $("leftTintOn").addEventListener("change", () => { state.textIcons.leftTintOn = $("leftTintOn").value === "true"; saveState(); });
      $("rightTintOn").addEventListener("change", () => { state.textIcons.rightTintOn = $("rightTintOn").value === "true"; saveState(); });
      $("leftTintColor").addEventListener("change", () => { state.textIcons.leftTintColor = $("leftTintColor").value; saveState(); });
      $("rightTintColor").addEventListener("change", () => { state.textIcons.rightTintColor = $("rightTintColor").value; saveState(); });

      $("leftFile").addEventListener("change", async (e) => {
        const f = e.target.files?.[0]; if(!f) return;
        state.textIcons.leftIconData = await fileToDataUrl(f);
        state.textIcons.leftIconMode = "upload";
        saveState();
        e.target.value = "";
      });

      $("rightFile").addEventListener("change", async (e) => {
        const f = e.target.files?.[0]; if(!f) return;
        state.textIcons.rightIconData = await fileToDataUrl(f);
        state.textIcons.rightIconMode = "upload";
        saveState();
        e.target.value = "";
      });

      // effects
      const bindBool = (id, path) => $(id).addEventListener("change", () => { path($(id).value === "true"); saveState(); });
      bindBool("sheenOn", v => state.effects.sheenOn = v);
      $("sheenOpacity").addEventListener("input", () => { state.effects.sheenOpacity = parseFloat($("sheenOpacity").value); saveState(); });
      $("sheenSpeedSec").addEventListener("input", () => { state.effects.sheenSpeedSec = parseFloat($("sheenSpeedSec").value); saveState(); });

      bindBool("scanOn", v => state.effects.scanOn = v);
      $("scanOpacity").addEventListener("input", () => { state.effects.scanOpacity = parseFloat($("scanOpacity").value); saveState(); });
      $("scanStep").addEventListener("input", () => { state.effects.scanStep = clamp($("scanStep").value,3,14); saveState(); });

      bindBool("grainOn", v => state.effects.grainOn = v);
      $("grainOpacity").addEventListener("input", () => { state.effects.grainOpacity = parseFloat($("grainOpacity").value); saveState(); });
      $("grainSize").addEventListener("input", () => { state.effects.grainSize = clamp($("grainSize").value,60,240); saveState(); });

      bindBool("vignetteOn", v => state.effects.vignetteOn = v);
      $("vignette").addEventListener("input", () => { state.effects.vignette = parseFloat($("vignette").value); saveState(); });

      bindBool("chromaOn", v => state.effects.chromaOn = v);
      $("chromaPx").addEventListener("input", () => { state.effects.chromaPx = clamp($("chromaPx").value,0,8); saveState(); });

      bindBool("shakeOn", v => state.effects.shakeOn = v);

      bindBool("sparksOn", v => state.effects.sparksOn = v);
      $("sparksAmount").addEventListener("input", () => { state.effects.sparksAmount = clamp($("sparksAmount").value,0,120); saveState(); });

      // embers
      bindBool("emberEnabled", v => state.ember.enabled = v);
      $("emberOpacity").addEventListener("input", () => { state.ember.opacity = parseFloat($("emberOpacity").value); saveState(); });
      $("emberSpeed").addEventListener("input", () => { state.ember.speed = parseFloat($("emberSpeed").value); saveState(); });
      $("emberTarget").addEventListener("input", () => { state.ember.targetCount = clamp($("emberTarget").value,0,160); saveState(); });
      $("emberC1").addEventListener("change", () => { state.ember.colors[0] = $("emberC1").value; saveState(); });
      $("emberC2").addEventListener("change", () => { state.ember.colors[1] = $("emberC2").value; saveState(); });
      $("emberC3").addEventListener("change", () => { state.ember.colors[2] = $("emberC3").value; saveState(); });

      // export/import
      $("btnExport").addEventListener("click", () => {
        $("jsonBox").value = JSON.stringify(state, null, 2);
      });
      $("btnImport").addEventListener("click", () => {
        try{
          const parsed = JSON.parse($("jsonBox").value || "{}");
          state = deepMerge(structuredClone(DEFAULTS), parsed);
          saveState();
          bind();
        } catch {
          alert("Invalid JSON");
        }
      });
      $("btnFactory").addEventListener("click", () => {
        state = structuredClone(DEFAULTS);
        saveState();
        bind();
      });
    }

    bind();
    wire();

    window.addEventListener("storage", (e) => {
      if(e.key !== STORAGE_KEY) return;
      state = loadState();
      bind();
    });
  </script>
</body>
</html>
